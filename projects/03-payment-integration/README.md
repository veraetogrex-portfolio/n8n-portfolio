# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º üí≥

–ï–¥–∏–Ω–∞—è –ø–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Stripe, PayPal, Yandex.Kassa —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π —Å—Ç–∞—Ç—É—Å–æ–≤ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π.

## üìù –û–ø–∏—Å–∞–Ω–∏–µ

–í–æ—Ä–∫—Ñ–ª–æ—É —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª–Ω—ã–º –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –ø–ª–∞—Ç–µ–∂–∞: –æ—Ç –∏–Ω–∏—Ü–∏–∞—Ü–∏–∏ –ø–ª–∞—Ç–µ–∂–∞, –æ–±—Ä–∞–±–æ—Ç–∫–∏ webhook'–æ–≤, –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å ClickHouse –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∑–∞–∫–∞–∑—á–∏–∫—É.

## üéØ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- ‚úÖ **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã**: Stripe, PayPal, Yandex.Kassa
- ‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ Webhook'–æ–≤**: –†–µ–∞–∫—Ü–∏—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è –ø–ª–∞—Ç–µ–∂–µ–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- ‚úÖ **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤**: payment_pending ‚Üí paid ‚Üí fulfilled
- ‚úÖ **ClickHouse –∞–Ω–∞–ª–∏—Ç–∏–∫–∞**: –°—Ç–æ–∏–º–æ—Å—Ç—å, –∫–æ–º–∏—Å—Å–∏–∏, –∫–æ–Ω–≤–µ—Ä—Å–∏—è
- ‚úÖ **–†–µ–∫–æ–Ω—Å–∏–ª—è—Ü–∏—è**: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö (API vs DB)
- ‚úÖ **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**: Email, SMS, Telegram, Push notifications
- ‚úÖ **Refund –æ–±—Ä–∞–±–æ—Ç–∫–∞**: –ü–æ–ª–Ω—ã–µ –∏ —á–∞—Å—Ç–∏—á–Ω—ã–µ –≤–æ–∑–≤—Ä–∞—Ç—ã
- ‚úÖ **Fraud detection**: –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
Customer initiates payment
        ‚Üì
Payment Provider (Stripe/PayPal)
        ‚Üì
    Webhook
        ‚Üì
  Parse Payment
        ‚Üì
Update Order Status
        ‚Üì
Log to ClickHouse
        ‚Üì
Send Notification
        ‚Üì
Trigger Fulfillment
```

## üîß –¢—Ä–µ–±—É–µ–º—ã–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

- Stripe API
- PayPal API
- Yandex.Kassa API
- ClickHouse (–¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏)
- Email (–¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)
- SMS (Twilio –¥–ª—è SMS)
- Telegram (–¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)
- Firebase (–¥–ª—è push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)

## üìä –ú–µ—Ç—Ä–∏–∫–∏ –∏ KPI

| –ú–µ—Ç—Ä–∏–∫–∞ | –¢–µ–∫—É—â–∏–π | –¶–µ–ª—å |
|---------|---------|------|
| Payment Success Rate | - | > 98% |
| Average Processing Time | - | < 2 —Å–µ–∫ |
| Fraud Detection Rate | - | < 0.5% |
| Reconciliation Rate | - | 99.9% |
| Webhook Delivery | - | 100% |

## üí∞ –ü–ª–∞—Ç–µ–∂–Ω—ã–π —Ü–∏–∫–ª

### 1. –ò–Ω–∏—Ü–∏–∞—Ü–∏—è
```
1. Customer –≤—ã–±–∏—Ä–∞–µ—Ç —Ç–æ–≤–∞—Ä
2. –°–∏—Å—Ç–µ–º–∞ –≤—ã–≤–æ–¥–∏—Ç —Ñ–æ—Ä–º—É –æ–ø–ª–∞—Ç—ã
3. Customer –≤–≤–æ–¥–∏—Ç –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã
4. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ Stripe/PayPal
```

### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞
```
1. –ü–ª–∞—Ç–µ–∂–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–ª–∞—Ç–µ–∂
2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç Webhook –≤ –Ω–∞—à –≤–æ—Ä–∫—Ñ–ª–æ—É
3. –ú—ã –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞
4. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ ClickHouse
```

### 3. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
```
1. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º Email receipt
2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º SMS —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º Telegram —Å–æ–æ–±—â–µ–Ω–∏–µ
4. –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å fulfillment
```

### 4. –í–æ–∑–≤—Ä–∞—Ç (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω)
```
1. Customer –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç refund
2. –ò–Ω–∏—Ü–∏–∏—Ä—É–µ–º refund —á–µ—Ä–µ–∑ –ø–ª–∞—Ç–µ–∂–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä
3. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞
4. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≤–æ–∑–≤—Ä–∞—Ç–µ
```

## üìã –ü—Ä–∏–º–µ—Ä –ø–ª–∞—Ç–µ–∂–∞

```json
{
  "event": "payment.success",
  "data": {
    "payment_id": "py_123456",
    "order_id": "ord_789",
    "amount": 9999,  // –≤ —Ü–µ–Ω—Ç–∞—Ö
    "currency": "USD",
    "provider": "stripe",
    "customer": {
      "email": "user@example.com",
      "phone": "+1234567890"
    },
    "status": "succeeded",
    "timestamp": "2026-01-15T10:30:00Z",
    "fee": 299,  // –∫–æ–º–∏—Å—Å–∏—è –ø–ª–∞—Ç–µ–∂–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
    "net_amount": 9700
  }
}
```

## üöÄ –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

- [ ] –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Stripe API
- [ ] –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ PayPal API
- [ ] Webhook –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–ª–∞—Ç–µ–∂–µ–π
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –≤ –ë–î
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ ClickHouse
- [ ] –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ refund'–æ–≤
- [ ] –†–µ–∫–æ–Ω—Å–∏–ª—è—Ü–∏—è –ø–ª–∞—Ç–µ–∂–µ–π
- [ ] Dashboard —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏

## üí° –û–∂–∏–¥–∞–µ–º—ã–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏

### –ü—Ä–æ–±–ª–µ–º–∞ 1: Webhook reliability
```
Scenario: Webhook –ø–æ—Ç–µ—Ä—è–µ—Ç—Å—è –≤ –ø—É—Ç–∏
Solution: 
- Retry mechanism (exponential backoff)
- Webhook delivery tracking –≤ –ë–î
- Periodic reconciliation –ø—Ä–æ–≤–µ—Ä–∫–∞
```

### –ü—Ä–æ–±–ª–µ–º–∞ 2: Race conditions
```
Scenario: –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –æ–¥–∏–Ω –ø–ª–∞—Ç–µ–∂
Solution:
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å idempotency keys (Stripe)
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ ClickHouse
- Mutex –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
```

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –†–∞–∑–Ω—ã–µ –≤–∞–ª—é—Ç—ã –∏ –∫–æ–º–∏—Å—Å–∏–∏
```
Scenario: –ü–ª–∞—Ç–µ–∂ –≤ EUR —á–µ—Ä–µ–∑ Stripe, –Ω–æ –∫–æ–º–∏—Å—Å–∏—è –≤ USD
Solution:
- –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤–∞–ª—é—Ç—É –≤ ClickHouse
- –°–æ—Ö—Ä–∞–Ω—è—Ç—å –∏—Å—Ö–æ–¥–Ω—É—é –≤–∞–ª—é—Ç—É
- –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ
```

## üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤ ClickHouse

```
CREATE TABLE payments (
  payment_id String,
  order_id String,
  amount UInt32,
  currency String,
  provider Enum('stripe', 'paypal', 'yandex'),
  status Enum('pending', 'succeeded', 'failed', 'refunded'),
  fee UInt32,
  net_amount UInt32,
  created_at DateTime,
  completed_at DateTime,
  customer_email String
) ENGINE = MergeTree()
ORDER BY (created_at, provider);
```

### –ü–æ–ª–µ–∑–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã:

```sql
-- –û–±—â–∏–π –æ–±—ä–µ–º –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º
SELECT provider, sum(amount) as total 
FROM payments 
WHERE created_at > today() - 30
GROUP BY provider;

-- Success rate –ø–æ —á–∞—Å–∞–º
SELECT toStartOfHour(created_at) as hour,
       countIf(status = 'succeeded') / count() * 100 as success_rate
FROM payments
GROUP BY hour
ORDER BY hour DESC;

-- –°—Ä–µ–¥–Ω—è—è –∫–æ–º–∏—Å—Å–∏—è
SELECT provider, avg(fee * 100.0 / amount) as commission_pct
FROM payments
WHERE status = 'succeeded'
GROUP BY provider;
```

---

**–°—Ç–∞—Ç—É—Å:** üìÖ –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í—ã—Å–æ–∫–∏–π
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –í—ã—Å–æ–∫–∞—è (–∫—É—á–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π)
